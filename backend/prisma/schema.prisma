generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum NotificationType {
  EMAIL
  IN_APP
  PUSH
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model User {
  id                   BigInt                  @id @default(autoincrement())
  // Existing fields assumed here (e.g., email, name, etc.)
  createdAt            DateTime                @default(now()) @map("created_at")
  updatedAt            DateTime                @updatedAt @map("updated_at")

  notifications        Notification[]
  notificationPreference NotificationPreference?
  createdAnnouncements Announcement[] @relation("createdAnnouncements")
  userClassrooms       M01UserClassroom[]

  @@map("users")
}

model Notification {
  id        BigInt         @id @default(autoincrement())
  userId    BigInt         @map("user_id")
  type      NotificationType
  priority  Priority
  title     String
  message   String
  isRead    Boolean        @default(false) @map("is_read")
  readAt    DateTime?      @map("read_at")
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

model Announcement {
  id          BigInt          @id @default(autoincrement())
  creatorId   BigInt?         @map("creator_id")
  title       String
  content     String
  type        NotificationType
  priority    Priority
  isActive    Boolean         @default(true) @map("is_active")
  publishedAt DateTime        @default(now()) @map("published_at")
  expiresAt   DateTime?       @map("expires_at")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  creator     User?           @relation("createdAnnouncements", fields: [creatorId], references: [id], onDelete: SetNull)

  @@index([creatorId])
  @@map("announcements")
}

model NotificationPreference {
  id            BigInt    @id @default(autoincrement())
  userId        BigInt    @unique @map("user_id")
  emailEnabled  Boolean   @default(true) @map("email_enabled")
  inAppEnabled  Boolean   @default(true) @map("in_app_enabled")
  pushEnabled   Boolean   @default(false) @map("push_enabled")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// =============================================================================
// M01 - Establecimiento Module: Establishments, Subjects, Classrooms, Enrollment
// =============================================================================

/// Role within a classroom context
enum M01ClassroomRole {
  STUDENT
  TEACHER
  ASSISTANT
  ADMINISTRATOR

  @@map("m01_classroom_role")
}

/// Establishment entity - represents a school or educational institution
model M01Establishment {
  id          BigInt    @id @default(autoincrement())
  name        String
  code        String    @unique
  address     String?
  phone       String?
  email       String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  classrooms  M01Classroom[]
  subjects    M01Subject[]

  @@index([code])
  @@index([isActive])
  @@map("m01_establishments")
}

/// Subject entity - represents a course or academic subject
model M01Subject {
  id              BigInt    @id @default(autoincrement())
  establishmentId BigInt    @map("establishment_id")
  name            String
  code            String
  description     String?
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  establishment   M01Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  classrooms      M01Classroom[]

  @@unique([establishmentId, code])
  @@index([establishmentId])
  @@index([isActive])
  @@map("m01_subjects")
}

/// Classroom entity - represents a classroom that belongs to an establishment and may be associated with a subject
model M01Classroom {
  id              BigInt    @id @default(autoincrement())
  establishmentId BigInt    @map("establishment_id")
  subjectId       BigInt?   @map("subject_id")
  name            String
  code            String
  capacity        Int?
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  establishment   M01Establishment   @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  subject         M01Subject?        @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  userClassrooms  M01UserClassroom[]

  @@unique([establishmentId, code])
  @@index([establishmentId])
  @@index([subjectId])
  @@index([isActive])
  @@map("m01_classrooms")
}

/// User-Classroom enrollment - represents a user's enrollment in a classroom with a specific role
model M01UserClassroom {
  id          BigInt            @id @default(autoincrement())
  userId      BigInt            @map("user_id")
  classroomId BigInt            @map("classroom_id")
  role        M01ClassroomRole  @default(STUDENT)
  enrolledAt  DateTime          @default(now()) @map("enrolled_at")
  isActive    Boolean           @default(true) @map("is_active")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  classroom   M01Classroom      @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  @@unique([userId, classroomId])
  @@index([userId])
  @@index([classroomId])
  @@index([role])
  @@index([isActive])
  @@map("m01_user_classrooms")
}