generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "m01_establecimiento"]
}

// =============================================================================
// ENUMS
// =============================================================================

enum NotificationType {
  EMAIL
  IN_APP
  PUSH

  @@schema("public")
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@schema("public")
}

// =============================================================================
// M01 - CORE AUTH AND USER ENTITIES
// =============================================================================

/// Core user model for authentication and user management
model User {
  id                     BigInt                  @id @default(autoincrement())
  email                  String                  @unique @db.VarChar(255)
  password_hash          String                  @db.VarChar(255)
  first_name             String                  @db.VarChar(100)
  last_name              String                  @db.VarChar(100)
  is_active              Boolean                 @default(true)
  email_verified         Boolean                 @default(false)
  email_verified_at      DateTime?
  last_login_at          DateTime?
  failed_login_attempts  Int                     @default(0)
  locked_until           DateTime?
  created_at             DateTime                @default(now())
  updated_at             DateTime                @updatedAt

  // Relations
  notifications          Notification[]
  notification_preference NotificationPreference?
  created_announcements  Announcement[]          @relation("createdAnnouncements")
  user_roles             UserRole[]
  sessions               Session[]
  userClassrooms         M01UserClassroom[]

  @@index([email])
  @@index([is_active])
  @@index([created_at])
  @@map("m01_users")
  @@schema("m01_establecimiento")
}

/// Role model for RBAC system
model Role {
  id          BigInt   @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  description String?  @db.VarChar(255)
  is_system   Boolean  @default(false)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  role_permissions RolePermission[]
  user_roles       UserRole[]

  @@index([name])
  @@index([is_active])
  @@map("m01_roles")
  @@schema("m01_establecimiento")
}

/// Permission model for granular access control
model Permission {
  id          BigInt   @id @default(autoincrement())
  name        String   @unique @db.VarChar(100)
  resource    String   @db.VarChar(100)
  action      String   @db.VarChar(50)
  description String?  @db.VarChar(255)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  role_permissions RolePermission[]

  @@unique([resource, action])
  @@index([resource])
  @@index([action])
  @@map("m01_permissions")
  @@schema("m01_establecimiento")
}

/// Junction table for Role-Permission many-to-many relationship
model RolePermission {
  id            BigInt   @id @default(autoincrement())
  role_id       BigInt
  permission_id BigInt
  created_at    DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@unique([role_id, permission_id])
  @@index([role_id])
  @@index([permission_id])
  @@map("m01_role_permissions")
  @@schema("m01_establecimiento")
}

/// Junction table for User-Role many-to-many relationship
model UserRole {
  id         BigInt    @id @default(autoincrement())
  user_id    BigInt
  role_id    BigInt
  assigned_at DateTime @default(now())
  assigned_by BigInt?
  expires_at  DateTime?
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role Role @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@unique([user_id, role_id])
  @@index([user_id])
  @@index([role_id])
  @@index([expires_at])
  @@map("m01_user_roles")
  @@schema("m01_establecimiento")
}

/// Session model for user session management
model Session {
  id            BigInt    @id @default(autoincrement())
  user_id       BigInt
  token         String    @unique @db.VarChar(500)
  refresh_token String?   @unique @db.VarChar(500)
  ip_address    String?   @db.VarChar(45)
  user_agent    String?   @db.VarChar(500)
  is_valid      Boolean   @default(true)
  expires_at    DateTime
  last_activity DateTime  @default(now())
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
  @@index([refresh_token])
  @@index([is_valid])
  @@index([expires_at])
  @@map("m01_sessions")
  @@schema("m01_establecimiento")
}

// =============================================================================
// NOTIFICATION MODULE (existing models moved to public schema)
// =============================================================================

model Notification {
  id         BigInt           @id @default(autoincrement())
  user_id    BigInt
  type       NotificationType
  priority   Priority
  title      String
  message    String
  is_read    Boolean          @default(false)
  read_at    DateTime?
  created_at DateTime         @default(now())
  updated_at DateTime         @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([is_read])
  @@index([created_at])
  @@map("notifications")
  @@schema("public")
}

model Announcement {
  id          BigInt          @id @default(autoincrement())
  creatorId   BigInt?
  title       String
  content     String
  type        NotificationType
  priority    Priority
  isActive    Boolean         @default(true) @map("is_active")
  publishedAt DateTime        @default(now()) @map("published_at")
  expiresAt   DateTime?       @map("expires_at")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  creator     User?           @relation("createdAnnouncements", fields: [creatorId], references: [id], onDelete: SetNull)

  @@index([creatorId])
  @@index([isActive])
  @@index([publishedAt])
  @@map("announcements")
  @@schema("public")
}

model NotificationPreference {
  id             BigInt   @id @default(autoincrement())
  user_id        BigInt   @unique
  email_enabled  Boolean  @default(true)
  in_app_enabled Boolean  @default(true)
  push_enabled   Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
  @@schema("public")
}

// =============================================================================
// M01 - Establecimiento Module: Establishments, Subjects, Classrooms, Enrollment
// =============================================================================

/// Role within a classroom context
enum M01ClassroomRole {
  STUDENT
  TEACHER
  ASSISTANT
  ADMINISTRATOR

  @@map("m01_classroom_role")
}

/// Establishment entity - represents a school or educational institution
model M01Establishment {
  id          BigInt    @id @default(autoincrement())
  name        String
  code        String    @unique
  address     String?
  phone       String?
  email       String?
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  classrooms  M01Classroom[]

  @@index([code])
  @@index([is_active])
  @@map("m01_establishments")
  @@schema("m01_establecimiento")
}

model M01Subject {
  id          BigInt    @id @default(autoincrement())
  name        String
  code        String    @unique
  description String?
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  classrooms  M01Classroom[]

  @@index([code])
  @@index([is_active])
  @@map("m01_subjects")
  @@schema("m01_establecimiento")
}

model M01Classroom {
  id                BigInt    @id @default(autoincrement())
  establishment_id  BigInt
  subject_id        BigInt
  name              String
  code              String
  capacity          Int?
  is_active         Boolean   @default(true)
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  establishment     M01Establishment   @relation(fields: [establishment_id], references: [id], onDelete: Cascade)
  subject           M01Subject         @relation(fields: [subject_id], references: [id], onDelete: Cascade)
  userClassrooms    M01UserClassroom[]

  @@unique([establishment_id, code])
  @@index([establishment_id])
  @@index([subject_id])
  @@index([is_active])
  @@map("m01_classrooms")
  @@schema("m01_establecimiento")
}

model M01UserClassroom {
  id            BigInt    @id @default(autoincrement())
  user_id       BigInt
  classroom_id  BigInt
  role          String    @default("student")
  enrolled_at   DateTime  @default(now())
  is_active     Boolean   @default(true)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  user          User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  classroom     M01Classroom  @relation(fields: [classroom_id], references: [id], onDelete: Cascade)

  @@unique([user_id, classroom_id])
  @@index([user_id])
  @@index([classroom_id])
  @@index([is_active])
  @@map("m01_user_classrooms")
  @@schema("m01_establecimiento")
}
